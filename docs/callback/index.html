<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Slack Mention Notifier ‚Äî Authorization</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            text-align: center;
            padding: 80px 20px;
            background: #f8f8f8;
            color: #333;
        }
        .card {
            max-width: 520px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 { font-size: 24px; margin-bottom: 8px; }
        p { color: #666; line-height: 1.6; }
        .spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid #ddd;
            border-top-color: #4A154B;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .hidden { display: none; }
        .error-text { color: #c00; }
        .steps {
            text-align: left;
            margin: 20px 0;
            padding: 0;
            list-style: none;
        }
        .steps li {
            padding: 8px 0;
            padding-left: 32px;
            position: relative;
            color: #444;
        }
        .steps li::before {
            content: attr(data-num);
            position: absolute;
            left: 0;
            width: 22px;
            height: 22px;
            background: #4A154B;
            color: white;
            border-radius: 50%;
            font-size: 12px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            top: 9px;
        }
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: #4A154B;
            color: white;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            margin-top: 16px;
            transition: background 0.2s;
        }
        .btn:hover { background: #611f69; }
        .btn-outline {
            background: transparent;
            color: #4A154B;
            border: 2px solid #4A154B;
        }
        .btn-outline:hover {
            background: rgba(74,21,75,0.06);
        }
        .link-row {
            margin-top: 20px;
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }
        code {
            display: block;
            background: #f0f0f0;
            padding: 12px;
            border-radius: 6px;
            margin: 12px 0;
            word-break: break-all;
            font-size: 13px;
        }
        .muted { font-size: 13px; color: #999; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="card">
        <!-- State: Redirecting to local app -->
        <div id="loading">
            <div class="spinner"></div>
            <h1>Connecting to app...</h1>
            <p>Redirecting to Slack Mention Notifier on your Mac.</p>
        </div>

        <!-- State: App installed from website (no local server) -->
        <div id="installed" class="hidden">
            <h1>‚úÖ App installed in your workspace!</h1>
            <p>The Slack app has been added to your workspace. Now each team member can connect individually.</p>
            <ol class="steps">
                <li data-num="1"><strong>Download</strong> the app from GitHub Releases</li>
                <li data-num="2"><strong>Launch</strong> it ‚Äî look for üîî in the menu bar</li>
                <li data-num="3">Click <strong>"Sign in with Slack"</strong> to connect your account</li>
            </ol>
            <a href="https://github.com/musketyr/slack-mention-notifier/releases/latest" class="btn">
                ‚¨á Download for macOS
            </a>
        </div>

        <!-- State: Authorization error -->
        <div id="denied" class="hidden error-text">
            <h1>‚ùå Authorization denied</h1>
            <p id="denied-reason"></p>
        </div>

        <!-- State: App is running but redirect failed, show manual fallback -->
        <div id="manual" class="hidden">
            <h1>‚ö†Ô∏è Could not reach the app</h1>
            <p>Make sure Slack Mention Notifier is running on your Mac, then try the link below.</p>
            <div class="link-row">
                <a id="localLink" href="#" class="btn">Open in app</a>
            </div>
            <p class="muted">
                Or copy this authorization code and paste it in the terminal:
            </p>
            <code id="codeDisplay"></code>
        </div>
    </div>
    <script>
        const params = new URLSearchParams(window.location.search);
        const code = params.get('code');
        const error = params.get('error');
        const localUrl = 'http://localhost:17380/slack/callback' + window.location.search;

        function showState(id) {
            ['loading', 'installed', 'denied', 'manual'].forEach(function(s) {
                document.getElementById(s).classList.toggle('hidden', s !== id);
            });
        }

        if (error) {
            // OAuth was denied or errored
            document.getElementById('denied-reason').textContent = error;
            showState('denied');
        } else if (code) {
            // Got a code ‚Äî try to send it to the local app
            document.getElementById('localLink').href = localUrl;
            document.getElementById('codeDisplay').textContent = code;

            // Attempt to reach the local server
            fetch(localUrl, { mode: 'no-cors' })
                .then(function() {
                    // Redirect to local app
                    window.location.href = localUrl;
                })
                .catch(function() {
                    // no-cors fetch doesn't tell us if it failed,
                    // so we use a timeout approach instead
                });

            // Try the redirect
            window.location.href = localUrl;

            // If we're still here after 2.5 seconds, the app isn't running
            setTimeout(function() {
                // Check if we're still on this page (redirect didn't work)
                showState('installed');
            }, 2500);
        } else {
            showState('denied');
            document.getElementById('denied-reason').textContent = 'Missing authorization code.';
        }
    </script>
</body>
</html>
